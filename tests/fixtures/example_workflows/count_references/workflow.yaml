operations:
  # Infer relations for the new class
  - name: infer_relation
    description: "Infer {{ relation_name }} for each Dataset"
    args:
      class_name: "{{ class_name }}"
      relation_name: "{{ relation_name }}"
      relation_path: "{{ relation_path }}"
    loop:
      - class_name: Dataset
        relation_name: samples
        relation_path: Dataset(files)>File<(files)Sample
      - class_name: File
        relation_name: datasets
        relation_path: File<(files)Dataset
  - name: transform_content
    description: "Count references for {{ class_name }}"
    args:
      class_name: "{{ class_name }}"
      content_schema: "{{ content_schema }}"
      embedding_profile: "{{ embedding_profile }}"
      data_template: "{{ data_template }}"
    loop:
      - class_name: Dataset
        content_schema: {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "additionalProperties": false,
          "description": "A dataset that is a collection of files.",
          "properties":
            {
              "dac_contact": { "type": "string" },
              "sample_summary":
                { "type": "object", "additionalProperties": true },
              "embedded_files":
                {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "additionalProperties": true,
                  }
                },
            },
          "required": ["sample_summary"],
          "type": "object",
        }
        embedding_profile: { files: { datasets: false }, samples: false }
        data_template: |
          {% for key, value in original.items() %}
          {% if key == "files" %}
            embedded_files: {{ value }}
          {% elif key != "samples" %}
            {{ key }}: {{ value }}
          {% endif %}
          {% endfor %}
            sample_summary:
              count: {{ original.samples | length }}
      - class_name: File
        content_schema: {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "additionalProperties": false,
          "description": "A file is an object that contains information generated from a process, either an Experiment or an Analysis.",
          "properties":
            {
              "checksum": { "type": "string" },
              "filename": { "type": "string" },
              "format": { "type": "string" },
              "size": { "type": "integer" },
              "dataset_summary":
                {
                  "type": "object",
                  "additionalProperties": true
                },
            },
          "required":
            ["filename", "format", "checksum", "size", "dataset_summary"],
          "type": "object",
        }
        embedding_profile: { datasets: false }
        data_template: |
          {% for key, value in original.items() %}
          {% if key != "datasets" %}
            {{ key }}: {{ value }}
          {% endif %}
          {% endfor %}
            dataset_summary:
              count: {{ original.datasets | length }}
      - class_name: Experiment
        content_schema: {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "additionalProperties": false,
          "description": "An experiment containing one or multiple samples.",
          "properties":
            {
              "description": { "type": "string" },
              "sample_summary":
                {
                  "type": "object",
                  "additionalProperties": true,
                  "properties": { "count": { "type": "integer" } },
                },
            },
          "required": ["sample_summary"],
          "type": "object",
        }
        embedding_profile: { samples: false }
        data_template: |
          {% for key, value in original.items() %}
          {% if key != "samples" %}
            {{ key }}: {{ value }}
          {% endif %}
          {% endfor %}
            sample_summary:
              count: {{ original.samples | length }}
